package com.sap.cds.feature.attachments.service;

import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.Marker;

import com.sap.cds.feature.attachments.service.model.servicehandler.MalwareScanEventContext;
import com.sap.cds.feature.attachments.utilities.LoggingMarker;
import com.sap.cds.services.ServiceDelegator;

/**
	* Default implementation of the {@link AttachmentMalwareScanService},
	* which is the connection to the malware scan service for a given attachment with name and keys.
	*/
//TODO Unit Tests
public class DefaultAttachmentMalwareScanService extends ServiceDelegator implements AttachmentMalwareScanService {

	private static final Logger logger = LoggerFactory.getLogger(DefaultAttachmentMalwareScanService.class);
	private static final Marker marker = LoggingMarker.MALWARE_SCAN_SCAN_METHOD.getMarker();

	public DefaultAttachmentMalwareScanService() {
		super(AttachmentMalwareScanService.DEFAULT_NAME);
	}

	/**
		* Scans the given attachment for malware and updates the scan result in the attachment entity
		*
		* @param attachmentEntityName Contains the attachment entity name
		* @param keys                 Contains the keys of the attachment entity
		* @throws com.sap.cds.services.ServiceException Exception to be thrown in case of errors during scanning the document
		*/
	@Override
	public void scanAttachment(String attachmentEntityName, Map<String, Object> keys) {
		logger.info(marker, "Method called to scan attachment {} with keys {} for malware", attachmentEntityName, keys);

		var context = MalwareScanEventContext.create();
		context.setAttachmentEntityName(attachmentEntityName);
		context.setAttachmentKeys(keys);

		emit(context);
	}

}
